#!/usr/bin/env node

'use strict';

process.title = 'grunt';

var options = require('../lib/cli').options;
var completion = require('../lib/completion');
var info = require('../lib/info');
var path = require('path');
var basedir = process.cwd();

// Do stuff based on CLI options.
if ('completion' in options) {
  completion.print(options.completion);
} else if (options.version) {
  info.version();
} else if (options.gruntfile) {
  basedir = path.resolve(path.dirname(options.gruntfile));
}

var gruntpath = info.gruntPath(basedir);

// No grunt install found!
if (!gruntpath) {
  if (options.version) {
    process.exit();
  }
  if (options.help) {
    info.help();
  }

  var failMsg = '\n  Unable to find local grunt.\n  Unable to install:\n';

  // Execute npm install if Gruntfile is found.
  if (info.gruntInstallable()) {
    console.log('\nRunning npm install...');
    require('child_process')
      .spawn('npm', ['install'], {cwd: basedir, stdio: 'inherit'})
      .on('exit', function (error) {
        gruntpath = info.gruntPath(basedir);
        if (!error && gruntpath) {
          console.log();
          require(gruntpath).cli();
        } else {
          var message = failMsg + '    Installation was attempted but failed';
          info.fatal(message, 99);
        }
      });

    // Unable to attempt npm install.
  } else {
    var message = failMsg + '    Gruntfile is missing.';
    info.fatal(message, 99);
  }

// Everything looks good. Require local grunt and run it.
} else {
  require(gruntpath).cli();
}
